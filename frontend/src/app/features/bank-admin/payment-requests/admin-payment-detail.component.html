<app-navbar></app-navbar>
<app-sidebar></app-sidebar>

<div class="container">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Payment Request Review</h1>
      <p>Request ID: #{{ requestId }}</p>
    </div>
    <a routerLink="/admin/payment-requests" class="btn btn-secondary">
      ‚Üê Back to List
    </a>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading payment request details...</p>
  </div>

  <!-- Payment Request Details -->
  <div *ngIf="!loading && paymentRequest" class="details-container">
    
    <!-- Status Card -->
    <div class="card status-card">
      <div class="status-header">
        <div class="status-icon">
          {{ getStatusIcon(paymentRequest.status) }}
        </div>
        <div>
          <h3>Request Status</h3>
          <span class="badge large" [ngClass]="getStatusClass(paymentRequest.status)">
            {{ paymentRequest.status }}
          </span>
        </div>
      </div>

      <!-- Action Buttons (Only for PENDING requests) -->
      <div class="action-row" *ngIf="canApprove || canReject">
        <button 
          class="btn btn-success" 
          (click)="approveRequest()"
          [disabled]="processing">
          <span *ngIf="!processing">‚úì Approve Request</span>
          <span *ngIf="processing">Processing...</span>
        </button>
        <button 
          class="btn btn-danger" 
          (click)="openRejectionModal()"
          [disabled]="processing">
          ‚úó Reject Request
        </button>
      </div>
    </div>

    <!-- Request Information -->
    <div class="card">
      <div class="card-header">
        <h3>Request Information</h3>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label>Request ID</label>
          <p>#{{ paymentRequest.id }}</p>
        </div>

        <div class="info-item">
          <label>Organization</label>
          <p><strong>{{ paymentRequest.organizationName }}</strong></p>
        </div>

        <div class="info-item">
          <label>Request Type</label>
          <p class="type-badge">{{ paymentRequest.requestType }}</p>
        </div>

        <div class="info-item">
          <label>Payment Period</label>
          <p><strong>{{ paymentRequest.month }} {{ paymentRequest.year }}</strong></p>
        </div>

        <div class="info-item">
          <label>Employee Count</label>
          <p *ngIf="paymentRequest.employeeCount">{{ paymentRequest.employeeCount }} employees</p>
          <p *ngIf="!paymentRequest.employeeCount">-</p>
        </div>

        <div class="info-item highlight">
          <label>Total Amount</label>
          <p class="amount-large">‚Çπ{{ paymentRequest.totalAmount | number:'1.2-2' }}</p>
        </div>

        <div class="info-item">
          <label>Created Date</label>
          <p>{{ paymentRequest.createdAt | date: 'dd MMM yyyy, hh:mm a' }}</p>
        </div>

        <div class="info-item">
          <label>Last Updated</label>
          <p>{{ paymentRequest.updatedAt | date: 'dd MMM yyyy, hh:mm a' }}</p>
        </div>

        <div class="info-item full-width" *ngIf="paymentRequest.remarks">
          <label>Organization Remarks</label>
          <p class="remarks-text">{{ paymentRequest.remarks }}</p>
        </div>
      </div>
    </div>

    <!-- Approval Information (if approved) -->
    <div class="card approval-card" 
         *ngIf="paymentRequest.status === PaymentRequestStatus.APPROVED || 
                paymentRequest.status === PaymentRequestStatus.PROCESSING ||
                paymentRequest.status === PaymentRequestStatus.COMPLETED">
      <div class="card-header success">
        <h3>‚úì Approval Information</h3>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label>Approved By</label>
          <p *ngIf="paymentRequest.approvedByName">{{ paymentRequest.approvedByName }}</p>
          <p *ngIf="!paymentRequest.approvedByName">Bank Admin</p>
        </div>

        <div class="info-item">
          <label>Approved Date</label>
          <p *ngIf="paymentRequest.approvedAt">
            {{ paymentRequest.approvedAt | date: 'dd MMM yyyy, hh:mm a' }}
          </p>
          <p *ngIf="!paymentRequest.approvedAt">-</p>
        </div>
      </div>
    </div>

    <!-- ‚≠ê BONUS FIX: Processing Information Card (Only for PROCESSING status) -->
    <div class="card approval-card" 
         *ngIf="paymentRequest.status === PaymentRequestStatus.PROCESSING">
      <div class="card-header success">
        <h3>‚öôÔ∏è Payment Processing</h3>
      </div>

      <div class="info-grid">
        <div class="info-item full-width">
          <label>Status</label>
          <p>Payment is currently being processed. Salary payments are being created for all employees.</p>
        </div>

        <div class="info-item">
          <label>Processing Started At</label>
          <p *ngIf="paymentRequest.updatedAt">
            {{ paymentRequest.updatedAt | date: 'dd MMM yyyy, hh:mm a' }}
          </p>
          <p *ngIf="!paymentRequest.updatedAt">-</p>
        </div>

        <div class="info-item">
          <label>Expected Completion</label>
          <p>Processing will complete automatically</p>
        </div>
      </div>
    </div>

    <!-- ‚≠ê ISSUE #2 FIX: Process Payment Button (Only for APPROVED or PROCESSING requests) -->
    <div class="card process-card" 
         *ngIf="paymentRequest.status === PaymentRequestStatus.APPROVED || 
                paymentRequest.status === PaymentRequestStatus.PROCESSING">
      <div class="card-header success">
        <h3>üí≥ Process Payment</h3>
      </div>

      <div class="process-content">
        <!-- Show instructions only for APPROVED status -->
        <div *ngIf="paymentRequest.status === PaymentRequestStatus.APPROVED">
          <p class="process-description">
            This payment request has been approved. Click below to process the salary payments.
            This will:
          </p>
          <ul class="process-steps">
            <li>‚úì Create salary payment records for all employees</li>
            <li>‚úì Generate PDF salary slips</li>
            <li>‚úì Send email notifications to employees</li>
            <li>‚úì Mark payment request as COMPLETED</li>
          </ul>

          <div class="warning-box">
            <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. Ensure all details are correct.
          </div>
        </div>

        <!-- ‚≠ê Show processing message for PROCESSING status -->
        <div *ngIf="paymentRequest.status === PaymentRequestStatus.PROCESSING">
          <div class="warning-box" style="background: #d4edda; border-color: #28a745; color: #155724;">
            <strong>‚úÖ Payment is being processed</strong><br>
            All salary payments have been initiated. The status will automatically update to COMPLETED once all payments are finalized.
          </div>
        </div>

        <!-- ‚≠ê ISSUE #2: Button with proper disable logic -->
        <button 
          class="btn btn-process" 
          (click)="processPayment()"
          [disabled]="processing || paymentRequest.status === PaymentRequestStatus.PROCESSING">
          
          <!-- Show for APPROVED status when not processing -->
          <span *ngIf="!processing && paymentRequest.status === PaymentRequestStatus.APPROVED">
            üí≥ Process Payment Now
          </span>
          
          <!-- Show when actively processing -->
          <span *ngIf="processing">
            ‚è≥ Processing Payment...
          </span>
          
          <!-- Show for PROCESSING status when not actively clicking -->
          <span *ngIf="paymentRequest.status === PaymentRequestStatus.PROCESSING && !processing">
            ‚úÖ Payment Processing Complete
          </span>
        </button>
      </div>
    </div>

    <!-- Rejection Information (if rejected) -->
    <div class="card rejection-card" 
         *ngIf="paymentRequest.status === PaymentRequestStatus.REJECTED">
      <div class="card-header danger">
        <h3>‚úó Rejection Information</h3>
      </div>

      <div class="info-grid">
        <div class="info-item full-width">
          <label>Rejection Reason</label>
          <p class="rejection-reason">
            {{ paymentRequest.rejectionReason || 'No reason provided' }}
          </p>
        </div>

        <div class="info-item">
          <label>Rejected By</label>
          <p *ngIf="paymentRequest.approvedByName">{{ paymentRequest.approvedByName }}</p>
          <p *ngIf="!paymentRequest.approvedByName">Bank Admin</p>
        </div>

        <div class="info-item">
          <label>Rejected Date</label>
          <p *ngIf="paymentRequest.approvedAt">
            {{ paymentRequest.approvedAt | date: 'dd MMM yyyy, hh:mm a' }}
          </p>
          <p *ngIf="!paymentRequest.approvedAt">-</p>
        </div>
      </div>
    </div>

    <!-- Review Guidelines (Only show for PENDING requests) -->
    <div class="card guidelines-card" *ngIf="canApprove">
      <div class="card-header">
        <h3>üìã Review Guidelines</h3>
      </div>

      <div class="guidelines-content">
        <h4>Before Approving, Please Verify:</h4>
        <ul>
          <li>‚úì Organization is verified and in good standing</li>
          <li>‚úì Payment amount matches expected salary structure</li>
          <li>‚úì Employee count is accurate</li>
          <li>‚úì No duplicate requests for the same period</li>
          <li>‚úì Organization has sufficient credit/approval for the amount</li>
          <li>‚úì All employee bank details are verified</li>
        </ul>

        <div class="warning-box">
          <strong>‚ö†Ô∏è Important:</strong> Once approved, payments will be processed automatically. 
          Please ensure all details are correct before approval.
        </div>
      </div>
    </div>

  </div>

  <!-- Rejection Modal -->
  <div class="modal-overlay" *ngIf="showRejectionModal" (click)="closeRejectionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Reject Payment Request</h3>
        <button class="close-btn" (click)="closeRejectionModal()">‚úï</button>
      </div>

      <form [formGroup]="rejectionForm" (ngSubmit)="rejectRequest()">
        <div class="modal-body">
          <p class="modal-description">
            Please provide a reason for rejecting this payment request. 
            This will be visible to the organization.
          </p>

          <div class="form-group">
            <label class="form-label" for="rejectionReason">
              Rejection Reason <span class="required">*</span>
            </label>
            <textarea 
              id="rejectionReason"
              class="form-control" 
              formControlName="rejectionReason"
              placeholder="Enter detailed reason for rejection (minimum 10 characters)"
              rows="4"
              [class.error]="rejectionForm.get('rejectionReason')?.invalid && 
                            rejectionForm.get('rejectionReason')?.touched">
            </textarea>
            
            <div class="error-message" 
                 *ngIf="rejectionForm.get('rejectionReason')?.invalid && 
                        rejectionForm.get('rejectionReason')?.touched">
              <span *ngIf="rejectionForm.get('rejectionReason')?.errors?.['required']">
                Rejection reason is required
              </span>
              <span *ngIf="rejectionForm.get('rejectionReason')?.errors?.['minlength']">
                Reason must be at least 10 characters
              </span>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeRejectionModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger" [disabled]="processing">
            <span *ngIf="!processing">Reject Request</span>
            <span *ngIf="processing">Rejecting...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <app-loader *ngIf="processing"></app-loader>
</div>